generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  STUDENT
  ADMIN
}

enum PaymentStatus {
  PENDING_PAYMENT
  PENDING_REVIEW
  COMPLETED
  FAILED
  REJECTED
  REFUNDED
}

enum PaymentProvider {
  STRIPE
  CHARGILY
  CCP_OFFLINE
}

enum Currency {
  EUR
  DZD
}

enum CourseAccessType {
  FREE
  SUBSCRIPTION
  PREMIUM
}

enum ProductType {
  COURSE_LIFETIME
  SUBSCRIPTION_PERIOD
}

enum LessonType {
  VIDEO
  TEXT
  QUIZ
}

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
}

model User {
  id                String   @id @default(uuid())
  email             String   @unique
  password          String
  country           String?
  role              Role     @default(STUDENT)
  subscriptionEndsAt DateTime?
  purchases         Purchase[]
  progress          Progress[]
  messages          Message[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Course {
  id          String   @id @default(uuid())
  title       Json
  description Json
  accessType  CourseAccessType @default(PREMIUM)
  priceEur    Decimal?
  priceDzd    Decimal?
  thumbnail   String
  published   Boolean  @default(false)
  sections    Section[]
  purchases   Purchase[]
  coupons     Coupon[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SubscriptionPlan {
  id          String   @id @default(uuid())
  name        Json
  durationDays Int
  priceEur    Decimal
  priceDzd    Decimal
  isActive    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Section {
  id       String    @id @default(uuid())
  title    Json
  courseId String
  course   Course    @relation(fields: [courseId], references: [id])
  lessons  Lesson[]
  order    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Lesson {
  id        String   @id @default(uuid())
  title     Json
  type      LessonType
  videoUrl  String?
  duration  Int
  isFree    Boolean  @default(false)
  sectionId String
  section   Section  @relation(fields: [sectionId], references: [id])
  messages  Message[]
  progress  Progress[]
  videoKey  VideoKey?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Coupon {
  id        String   @id @default(uuid())
  code      String   @unique
  discount  Decimal
  type      CouponType
  expiresAt DateTime?
  maxUses   Int?
  usedCount Int      @default(0)
  courseId  String?
  course    Course?  @relation(fields: [courseId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Purchase {
  id             String          @id @default(uuid())
  userId         String
  user           User            @relation(fields: [userId], references: [id])
  productType    ProductType
  courseId       String?
  course         Course?         @relation(fields: [courseId], references: [id])
  subscriptionDurationDays Int?
  amount         Decimal
  currency       Currency        @default(EUR)
  provider       PaymentProvider
  status         PaymentStatus   @default(PENDING_PAYMENT)
  transactionId  String?
  receiptUrl     String?
  rejectionReason String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model Message {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  lessonId  String
  lesson    Lesson   @relation(fields: [lessonId], references: [id])
  parentId  String?
  timecode  Int?
  parent    Message? @relation("MessageReplies", fields: [parentId], references: [id])
  replies   Message[] @relation("MessageReplies")
}

model Progress {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  lessonId  String
  lesson    Lesson   @relation(fields: [lessonId], references: [id])
  completed Boolean  @default(false)
  position  Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@unique([userId, lessonId])
}

model VideoKey {
  id       String   @id @default(uuid())
  lessonId String   @unique
  lesson   Lesson   @relation(fields: [lessonId], references: [id])
  key      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
